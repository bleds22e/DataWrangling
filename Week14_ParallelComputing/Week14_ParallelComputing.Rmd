---
title: 'Week 14: Parallel Computing'
author: "Ellen Bledsoe"
output: pdf_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Parallel Computing

## Introduction

In our final week of class this semester, we are going to talk about how you can utilize the power that your computer (likely) has to your benefit when performing computationally complex tasks.

### Setup

We will be using a handful of new packages while learning about parallelization in R, and it is good practice to install and load those packages at the top of the script, so let's go ahead and do so.

```{r install-pkgs, eval = FALSE}
# install.packages("doParallel")
# install.packages("foreach")
```

And we load them into our working environment with the `library()` command.

```{r terra-load, echo = FALSE}
library(foreach)
library(doParallel)
library(tidyverse)
library(portalr)
```

Read in an R script that has a function that we want to use.
```{r}
source("capt_hist_fxn.R")
```

## WIP

Load the data
```{r}
ratdat <- portalr::summarize_individual_rodents() 
ratdat <- ratdat %>% 
  filter(tag != "0", !is.na(tag))
```

Create a smaller dataframe for us to work with for now
```{r}
ratdat_small <- ratdat[1:1000, ]
```

Introduce function
```{r}
# creating a capture history
# requires a dataframe of individual captures and a single tag
tags <- unique(ratdat_small$tag)

# and choose a tag to test
test_tag <- tags[123]
```

Test the function
```{r}
create_capture_hist(ratdat_small, test_tag)
```
Try with a for loop. We want to iterate through all of the values in the `tags` vector.

```{r}
# create empty data frame
capt_histories <- data.frame()

for (i in 1:length(tags)) {
  output <- create_capture_hist(ratdat_small, tags[i])
  capt_histories <- bind_rows(capt_histories, output)
}
```

The for loop worked pretty well! But that was only with 1000 rows, and we have over 63,000 rows to iterate through. What if we try 10,000 rows?

```{r}
ratdat_med <- ratdat[1:10000, ]
tags <- unique(ratdat_med$tag)

# create empty data frame
capt_histories <- data.frame()

for (i in 1:length(tags)) {
  output <- create_capture_hist(ratdat_small, tags[i])
  capt_histories <- bind_rows(capt_histories, output)
}
```



```{}
output <- foreach(i = 1:length(tags), .combine = rbind) %do% {
  create_capture_hist(test, tags[i])
}
```


## Resources

Parallel computing is still something I am learning myself! This lesson was heavily informed by the following sources which you might also find helpful:

-   [Beyond Single-Core R](https://ljdursi.github.io/beyond-single-core-R/#/) slidedeck
-   [Quick Intro to Parallel Computing in R](https://nceas.github.io/oss-lessons/parallel-computing-in-r/parallel-computing-in-r.html) by Matt Jones at NCEAS
-   [Parallelizing Code in R](https://wiki.weecology.org/docs/computers-and-programming/parallelization-r/) blog from the Weecology Lab
-   [`doParallel` vignette](https://cran.r-project.org/web/packages/doParallel/vignettes/gettingstartedParallel.pdf)
